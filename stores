<div id="loading_screen">
    <img alt="loading" src="//kodekloud.s3.amazonaws.com/sites/5447ebb66e6f641987020000/3604f5c26997bea3de504de139debcec/loading.gif"/>
</div>
<div  id="main_content" style="display:none">
    <nav>
        <ul class="breadcrumb">
            <li><a href="/home">Home</a> </li>
            <li class="active">Store Directory</li>
        </ul>
    </nav>
    <div class="page_banner">
        <h2> store directory</h2>
    </div>
    <div class="inside_page_content">
        <div class="left_column">
            <img class="inside_banner_image" alt="" src="//codecloud.cdn.speedyrails.net/sites/57f7bb6f6e6f647835430000/image/jpeg/1459362056000/insidebanner1.jpg"/>
            <div class="mobile_cat_list" style="display:none">
                <p class="right_column_header">categories</p>
                <div id="mobile_categories_container">
                    <a href="#categories_container" onclick="(show_cat('view_all', 'all'))" id="mobile_view_all_link" class="cat_links directory_content" style="font-weight:bold">View All</a><br>
                </div>
            </div>
            
            <div class="directory_div" id="no_cat_list">
                <p class="directory_header_name directory_name_col">Merchant Name</p><p class="directory_header_phone directory_phone_col">Phone</p>
                <div class="store_list" id="store_list_container">
                    <script id="store_list_template" type="x-tmpl-mustache/text">
                        <a href="/stores/{{slug}}"><p class="directory_content directory_name_col">{{name}}</p></a>
                        {{#phone}}<a href="tel:{{phone}}"><p class="directory_content directory_phone_col">{{phone}}</p></a>{{/phone}}
                    </script>
                </div>
                
            </div>
            <div class="directory_div" id="store_category_list_container">
                <script id="category_store_list_template" type="x-tmpl-mustache/text">
                    <div id="cat{{id}}" class="cat_list_div" style="display:none">
                        <p class="directory_header_name directory_name_col">{{name}}</p><p class="directory_header_phone directory_phone_col">Phone</p>
                        <div class="store_list" id="cat{{id}}_list"></div>
                    </div>
                </script>    
            </div>
        </div>
        <div class="right_column">
            <a href="/map" id="map_link"><p class="right_column_header">centre map</p></a>
            <br>
            <p class="right_column_header">categories</p>
            <div id="categories_container">
                <a href="#categories_container" onclick="(show_cat('view_all', 'all'))" id="view_all_link" class="cat_links directory_content" style="font-weight:bold">View All</a><br>
            </div>
            <br>
            <p class="right_column_header">centre information</p>
            <div id="centre_info_container">
                <script id="centre_info_template" type="x-tmpl-mustache/text">
                    <p class="directory_content">{{name}}</p>
                    <p class="directory_content">{{address1}}</p>
                    <p class="directory_content">{{city}}, {{province_state}} {{postal_code}}</p>
                </script>
            </div>
            
            
        </div>
    </div>
</div>
<script>
    if(navigator.appVersion.indexOf("MSIE 9.") == -1){
        
    } else {
        $("#map_link").hide();
    }
    $(document).ready(function() {
        function renderAll (){
            var propertyDetails = getPropertyDetails();
            renderPageData('#centre_info_container','#centre_info_template', propertyDetails, 'property_details');
            var stores = getStoresList();
            renderPageData('#store_list_container','#store_list_template', stores, "stores");
            var categories = getStoreCategories();
            var category_list = [];
            $.each( categories, function( key, val ){
                if (val.store_ids != null) {
                    category_list.push(val);
                } 
            });
            render_categories(category_list);
            render_category_stores();  
            
            $("#loading_screen").hide();
            $("#main_content").show();
        }
        
        function render_categories(categories){
            $.each( categories , function( key, val ) {
                val.link = "cat" + val.id;
                $("#categories_container").append('<a href="#categories_container" class="cat_links directory_content" onclick=(show_cat('+val.link+')) id="cat'+val.id+'_link">'+val.name+'</a><br>');
                $("#mobile_categories_container").append('<a href="#categories_container" class="cat_links directory_content" onclick=(show_cat('+val.link+')) id="mobile_cat'+val.id+'_link">'+val.name+'</a><br>');
            });
        }
        
        function renderPageData(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            if (type == "property_details"){
                item_list.push(collection);
                collection = []
                collection = item_list;
            }
            $.each( collection , function( key, val ) {
                if (type == "stores" || type == "category_stores"){
                    if(!val.store_front_url ||  val.store_front_url.indexOf('missing.png') > -1 || val.store_front_url.length === 0){
                        val.alt_store_front_url = "//codecloud.cdn.speedyrails.net/sites/57f7bb6f6e6f647835430000/image/jpeg/undefined/JMblacklogo.jpgg"    
                    } else {
                        val.alt_store_front_url = getImageURL(val.store_front_url);    
                    }
                    switch(val.z_coordinate) {
                        case 0: 
                            val.z_coordinate = "B2"
                            break;
                        case 1:
                            val.z_coordinate = "B1"
                            break;
                        case 2:
                            val.z_coordinate = "Level 1"
                            break;
                        case 3:
                            val.z_coordinate = "Level 2"
                            break;
                        case 4:
                            val.z_coordinate = "Level 3"
                            break;
                        case 5:
                            val.z_coordinate = "Level 4"
                            break;
                        case 6:
                            val.z_coordinate = "Level 5"
                            break;
                    }   
                }
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
            });
            $(container).show();
            $(container).html(item_rendered.join(''));
        }

        function render_category_stores(){
            var category_stores = [];
            var item_rendered = [];
            var all_stores = getStoresList();
            var all_categories = getStoreCategories();
            var test = []
            var template_html = $("#category_store_list_template").html();
            Mustache.parse(template_html);
            for (i = 0; i < all_categories.length; i++) {
                var stores_per_cat = [];
                for (j = 0; j < all_stores.length; j++) {
                    if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                        all_stores[j].cat_name = all_categories[i].name;
                        category_stores.push(all_stores[j]);
                        stores_per_cat.push(all_stores[j]);
                    }
                }
                var rendered = Mustache.render(template_html,all_categories[i]);
                item_rendered.push(rendered);
            }
            $("#store_category_list_container").show();
            $("#store_category_list_container").html(item_rendered.join(''));
            for (i = 0; i < all_categories.length; i++) {
                var stores_per_cat = [];
                for (j = 0; j < all_stores.length; j++) {
                    if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                        all_stores[j].cat_name = all_categories[i].name;
                        all_stores[j].alt_store_front_url = getImageURL(all_stores[j].store_front_url);    
                        populate_stores_for_cat(all_categories[i].id, all_stores[j]);
                    }
                }
            }
        }
    
        function populate_stores_for_cat (categoryid, store){
            $('#cat'+categoryid+'_list').append('<span id="store_for_'+store.id+'"><a href="../stores/'+store.slug+'"><p class="directory_content directory_name_col">'+store.name+'</p></a><a href="tel:'+store.phone+'"><p class="directory_content directory_phone_col">  '+store.phone+'</p></a></span>');
        }
    
        function goToStore(store_details){
            if(typeof(store_details) != 'undefined' && store_details != null){
                window.location.href = "/stores/"+store_details.slug;
            }
        }
    
        function getSVGMapURL(){
            initData();
            var mallDataJSON = JSON.parse(getStorage().mallData);
            return 'https://mallmaverick.cdn.speedyrails.net' + mallDataJSON.property.svgmap_url;
        }
    
        loadMallData(renderAll);  
    });
    
    function show_cat(link, type){
        $(".cat_links").css("font-weight","normal");
        if (type == "all"){
            $("#mobile_view_all_link").css("font-weight","bold");
            $("#view_all_link").css("font-weight","bold");
            $("#no_cat_list").show();
            $(".cat_list_div").hide();    
        } else {
            $("#mobile_"+link.id+"_link").css("font-weight","bold");
            $("#"+link.id+"_link").css("font-weight","bold");
            $("#no_cat_list").hide();
            $(".cat_list_div").hide();
            $("#"+link.id).show();    
        }
    }
</script>